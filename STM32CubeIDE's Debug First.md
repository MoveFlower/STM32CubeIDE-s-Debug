# 白皮书（White paper）
# 用SWV进行系统分析和实时跟踪

# （摘要）ABSTRACT
ARM®Cortex®微控制器继续推动价格/性能比达到前所未有的水平。此外，将CoreSight调试体系结构的一个子集包含在这些设备族中可以极大地改进调试功能，而不会产生过多的成本。现在可以比以前更清楚地看到复杂的实时嵌入式应用程序的动态。这种可见性不仅在当今产品中常见的日益复杂的应用程序中非常有用，而且在调试过程中无法停止的应用程序中也非常有用。
本白皮书概述了作为CoreSight体系结构一部分的串行线查看器和相关技术如何在嵌入式应用程序全速运行时用于高级调试。
# （简介）INTRODUTION
发现软件中的bug是一个困难且耗时的过程。在许多嵌入式应用程序中，调试通常比较困难，原因如下。执行时间通常很关键，并且结果可能会因为包含了检测代码而受到影响。对于电机、执行器或其他控制应用程序，可能无法停止或特别显示正在测试的设备进行调试操作。在许多应用程序中，为了保持中断以及内部或外部事件的同步，需要在应用程序执行时检查资源。

来自ARM的串行线查看器(SWV)技术，可在Cortex-M微控制器产品系列中找到，在应用程序全速运行时，提供实时跟踪和无处理器开销的内存访问。这是由设备的内部架构实现的，不需要软件支持，如低优先级守护进程或必须与应用程序链接的监视器代码。当应用程序执行时，插装跟踪宏单元(ITM)是一种通过32个ITM端口之一传输数据的微创方式。这使得printf()样式的调试不需要物理UART、USB、以太网或其他类型的通信通道。

本白皮书简要介绍了串行线查看器(SWV)和仪器跟踪宏单元(ITM)技术的背景。它还概述了高级调试器如何利用SWV和ITM技术向开发人员交付强大的调试功能。许多嵌入式开发人员继续使用“可靠的”调试方法，如闪烁的LED和printf()输出。易于使用,信息内容和现代调试技术被认为是成本效率,是值得开发的同时投入相对少量的努力熟悉这些方法节省了时间在调试和测试的回报将是相当大的。

# （串行线查看器概述）SERIAL WIRE VIEWER OVERVIEW
为了在兼容的ARM处理器中使用系统分析和实时跟踪，许多不同的技术相互作用;串行线查看器(SWV)，串行线调试(SWD)和串行线输出(SWO)。下文将解释它们各自的作用.
# （串行线调试）SERIAL WIRE DEBUG (SWD)
串行线调试(SWD)是一个类似于JTAG的调试端口，它提供了相同的调试功能(在断点上运行、停止、单步执行)，但是使用的引脚更少。它用一个2针接口(一个时钟针和一个双向数据针)替换JTAG连接器。SWD端口本身不提供实时跟踪。
# （串行线输出）SERIAL WIRE OUTPUT (SWO)
串行线输出(SWO)引脚可以与SWD结合使用，处理器使用它来发出实时跟踪数据，从而用第三个引脚扩展两个SWD引脚。两个SWD引脚和SWO引脚的组合使串行线查看器(SWV)能够在兼容的ARM处理器中实时跟踪。
# （串行线查看器）SERIAL WIRE VIEWER (SWV)
串行线输出(SWO)引脚可以与SWD结合使用，处理器使用它来发出实时跟踪数据，从而用第三个引脚扩展两个SWD引脚。串行线查看器是一种实时跟踪技术，它使用串行线调试器(SWD)端口和串行线输出(SWO)引脚。串行线路查看器提供了高级的系统分析和实时跟踪，而不需要停止处理器来提取某些类型的调试信息。

串行线查看器(SWV)可以提供以下类型的目标信息:

> Periodic 样本 程序 计数器 (PC) 值
> Event 通知 在 内存 访问 (such reading/writing C variables)
> Event 通知 异常 出入境
> Event 计数器
> Timestamp 和 CPU 周期 信息

基于这些跟踪数据，现代调试器可以为开发人员提供高级调试器功能。开发者可以通过许多不同的方式配置SWV，使其发出各种信息组合，如内存位置值、事件值、PC值等。由于启用了更多类型的跟踪数据进行传输，因此需要将更多的跟踪包从CPU发送到PC调试器。在某些情况下，PC上的前端调试软件可能无法接收所有的数据。
这有几个原因。全速运行的目标CPU可能会超出单针SWO输出的带宽。此外，跟踪数据通过内部缓冲区到达SWO，而内部缓冲区的深度有限。如果CPU生成的跟踪包超过了SWO引脚的传输能力，就会导致数据包丢失。这是正常的。
原因是Cortex-M微控制器的设计是为了满足激进的成本目标。资源限制是资源和成本之间权衡的副产品，在某种程度上是“设计的”。虽然这对所能完成的工作有一些轻微的限制，但是如果小心使用，SWV和ITM能够提供非常强大的调试信息，在某些情况下，如果没有非常昂贵的调试硬件，这些信息是无法获得的。

# （插装跟踪宏单元）INSTRUMENTATION TRACE MACRO CELL (ITM)
插装跟踪宏单元(ITM)使应用程序能够将任意数据写入SWO pin，然后可以在调试器中以各种方式解释和显示这些数据。例如，可以使用ITM将printf()输出重定向到调试器中的控制台视图。
出于以下几个原因，这是非常可取和有用的。首先，开销非常低，因为一个内存位置可以在一个时钟周期内传输。其次，不需要像UART或USB连接这样的车载资源，因为数据是使用调试探测硬件传输的。第三，ITM端口有32个通道，通过将不同类型的数据写入不同的ITM通道，调试器可以对不同通道上的数据进行不同的解释或可视化。
由于向ITM端口写入一个字节只需要一个时钟周期，因此应用程序可以在产品交付时保留ITM跟踪工具。然后就不需要重新构建和重新测试去掉了仪器的产品构建。在已发布的代码中保留这类工具还提供了将调试器连接到现场的活动系统的功能，以便在已部署的产品中进行详细分析。

# （系统分析和实时跟踪）SYSTEM ANALYSIS AND REAL-TIME TRACING
现代调试器可以利用串行线查看器(SWV)为嵌入式开发人员提供许多高级调试器功能。本节概述了在Atollic TrueSTUDIO Pro中发现的一些串行线查看器调试器特性(仅兼容ARM目标)

# (串行线查看器跟踪配置）SWV TRACE CONFIGURATION
串行线查看器(SWV)可以在Atollic TrueSTUDIO Pro调试配置对话框中启用。要启用SWV，请通过选择相应的复选框并选择CPU核心时钟频率和所需的SWO时钟速度来启用SWV。
所有JTAG探测都不支持SWV。例如，第一代ST-LINK没有，但是ST-LINK/V2有。比硬件版本6.0更老的SEGGER J-Link则没有。J-Link v6.0、v7.0和v8.0都支持SWV。
![1](1.PNG)
要使SWV工作，重要的是要确保选择了SWD模式，启用了SWV，并且正确配置了CPU核心时钟速度和SWO时钟。
特别重要的是要注意SWD/JTAG单选按钮。有时，半导体制造商提供的较老的项目默认设置了JTAG，忽略这一点肯定会禁用SWV。
一旦启用了SWV，就可以启动调试会话并运行到第一个断点，通常是在on- on-reset中断处理程序或main()函数的第一行。
要捕获的事件的配置在SWV跟踪配置对话框中进行配置。在任何SWV停靠视图中单击“锤子和扳手”工具栏按钮都可以打开此对话框
![2](2.PNG)
一旦打开SWV配置对话框，用户将看到许多SWV跟踪设置:
![3](3.PNG)
当选择了所需的SWV事件包时，必须激活跟踪记录按钮以启用跟踪记录的记录。这是通过点击红色的“记录”按钮来完成的。看到它的显示被改变是它被激活的方式。
![4](4.PNG)
现在启用了串行线路查看器跟踪，并配置了所需的事件通知类型，跟踪记录将被激活。当应用程序执行时，调试器将通过调试探测从处理器接收SWV跟踪记录，并且只要目标执行继续，调试器软件将实时更新其跟踪视图。

# （串行线查看器主视图和图形时间轴图表）SWV TRACE LOG AND GRAPHICAL TIMELINE CHART
串行线查看器主视图是SWV跟踪日志，以及附带的图形时间轴图表。SWV跟踪日志列出了在当前调试会话期间记录的所有跟踪记录。
![5](5.PNG)
SWV跟踪日志提供关于记录的跟踪记录的详细信息。如果需要快速查看跟踪结果，那么图形化的SWV跟踪时间轴图形视图更好，因为它以一种易于理解的方式可视化跟踪数据。
![6](6.PNG)
SWV跟踪日志和SWV跟踪时间轴图形视图都是实时更新的，而且图形甚至具有平滑滚动和各种缩放功能。graph view提供了在时间和时钟周期模式之间进行切换的功能，并提供了将图形的屏幕快照保存到文件中的功能。

# （串行线查看器数据日志及其附带的图形时间轴图表）SWV DATA TRACE AND GRAPHICAL TIMELINE CHART 
SWV数据跟踪日志及其附带的图形时间轴图表提供了有关内存位置和C变量当前值的信息，以及在当前调试会话期间记录的所有内存访问。
SWV数据跟踪日志显示所选C变量或内存位置的实时更新值，包括不同的8/16/32位整数和浮点数据类型。通过在Watch窗格中选择一个受监视的数据对象，该数据对象的内存访问列表也会在History窗格中列出，并提供详细信息。
![7](7.PNG)
如果将SWV跟踪配置为为每个内存访问发出程序计数器(PC)值，则在内存访问历史列表中双击，将自动打开导致特定内存访问的源代码文件和行号。
与SWV跟踪日志一样，SWV数据跟踪日志也附带一个图形化的SWV DataTrace时间轴图形视图。这个图形化的图表提供了前所未有的关于不同的变量值在执行期间如何随时间变化以及它们之间如何相互关联的概述。
![8](8.PNG)
通过将鼠标移动到图表的特定部分上，工具提示将显示附加信息，如时间戳和所有受监控的C变量或内存地址在该时间位置的确切值。
![9](9.PNG)
SWV数据跟踪日志和SWV DataTrace时间轴图形视图在执行期间都是实时更新的，而且图形甚至具有平滑滚动和各种缩放功能。graph view提供了在时间和时钟周期模式之间进行切换的功能，并提供了将图形的屏幕快照保存到文件中的功能。
